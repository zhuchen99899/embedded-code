#include <stm32f10x.h>
#include <tem.h>

/*
0-350°
温度-电阻对照表
分度为1°
*/

const float PT100[351]=
{100,100.39,100.78,101.17,101.56,101.95,102.34,102.73,103.13,103.51,103.9,    //0~10°电阻
104.29,104.68,105.07,105.46,105.85,106.24,106.63,107.02,107.40,107.79,         //11°~20°电阻
108.18,108.57,108.96,109.35,109.73,110.12,110.51,110.90,111.28,111.67,         //21°~30°电阻
112.06,112.45,112.83,113.22,113.61,113.99,114.38,114.77,115.15,115.54,         //31°~40°电阻
115.93,116.31,116.70,117.08,117.47,117.86,118.24,118.62,119.01,119.46,         //41°~50°电阻
119.78,120.16,120.55,120.93,121.32,121.70,122.09,122.47,122.86,123.24,         //51°~60°电阻
123.62,124.01,124.39,124.77,125.16,125.54,125.92,126.31,126.69,127.07,			//61°~70°电阻
127.45,127.84,128.22,128.60,128.98,129.37,129.75,130.13,130.51,130.89,			//71°~80°电阻
131.27,131.66,132.04,132.42,132.80,133.18,133.56,133.94,134.32,134.70,          //81°~90°电阻
135.08,135.46,135.84,136.22,136.60,136.98,137.36,137.74,138.12,138.50,			//91°~100°电阻
138.88,139.26,139.64,140.02,140.39,140.77,141.15,141.53,141.91,142.29,			//101°~110°电阻
142.66,143.04,143.42,143.80,144.17,144.55,144.93,145.31,145.68,146.06,			//111°~120°电阻
146.44,146.81,147.19,147.57,147.94,148.32,148.70,149.07,149.45,149.82,			//121°~130°电阻
150.20,150.57,150.95,151.33,151.70,152.08,152.45,152.83,153.20,153.58,			//131°~140°电阻
153.95,154.32,154.70,155.07,155.45,155.82,156.19,156.57,156.94,157.31,			//141°~150°电阻
157.69,158.06,158.43,158.81,159.18,159.55,159.93,160.30,160.67,161.04,			//151°~160°电阻
161.42,161.79,162.16,162.53,162.90,163.27,163.65,164.02,164.39,164.76,			//161°~170°电阻
165.13,165.50,165.87,166.24,166.61,166.98,167.35,167.72,168.09,168.46,			//171°~180°电阻
168.83,169.20,169.57,169.94,170.31,170.68,171.05,171.42,171.79,172.16,			//181°~190°电阻
172.53,172.90,173.26,173.63,174.00,174.37,174.74,175.10,175.47,175.84,			//191°~200°电阻
176.21,176.57,176.94,177.31,177.68,178.04,178.41,178.78,179.14,179.51,			//201°~210°电阻
179.88,180.24,180.61,180.97,181.34,181.71,182.07,182.44,182.80,183.17,			//211°~220°电阻
183.53,183.90,184.26,184.63,184.99,185.36,185.72,186.09,186.45,186.82,			//221°~230°电阻
187.18,187.54,187.91,188.27,188.63,189.00,189.36,189.72,190.09,190.45,			//231°~240°电阻
190.81,191.18,191.54,191.90,192.26,192.63,192.99,193.35,193.71,194.07,			//241°~250°电阻
194.44,194.80,195.16,195.52,195.88,196.24,196.60,196.96,197.33,197.69,			//251°~260°电阻
198.05,198.41,198.77,199.13,199.49,199.85,200.21,200.57,200.93,201.29,			//261°~270°电阻
201.65,202.01,202.36,202.72,203.08,203.44,203.80,204.16,204.52,204.88,			//271°~280°电阻
205.23,205.59,205.95,206.31,206.67,207.02,207.38,207.74,208.10,208.45,			//281°~290°电阻
208.81,209.17,209.52,209.88,210.24,210.59,210.95,211.31,211.66,212.02,			//291°~300°电阻
212.37,212.73,213.09,213.44,213.80,214.15,214.51,214.86,215.22,215.61,			//301°~310°电阻
215.96,216.32,216.67,217.03,217.38,217.74,218.09,218.44,218.80,219.15,			//311°~320°电阻
219.51,219.86,220.21,220.57,220.92,221.27,221.63,221.98,222.33,222.69,			//321°~330°电阻
223.04,223.39,223.74,224.10,224.45,224.80,225.15,225.50,225.86,226.21,			//331°~340°电阻
226.56,226.90,227.26,227.61,227.96,228.31,228.66,229.02,229.34,229.72			//341°~350°电阻
};

float find_PT100(float res)     //两分法
{
	u32 start,mid,end;
	float dat;
	
	start=0;
	end=350;
	
	if  ((dat<100)||(dat>229.72))
	{
	return 0xFFFF;     //超出表的范围
	
	}
	while(start<=end)
	{
		mid=(end+start)>>1;  //mid=(end+start)/2
		dat=PT100[mid];
		if(res>dat)      //如果数据大于下标
		{
		start=mid+1;       //表起始位置+1
		}
		else if(res<dat)  //如果电阻小于表中数据
		{
			if(mid)    //mid!=0 表没有查完
			{
			end=mid-1;    //表结尾位置-1
			
			}
			else        //mid=0 即END+START=0 表已经查完
			{
			break;  
			}
		}
		else         //res=dat AD测得电阻正好为表中值
		{
			return mid;    //返回表下标值
		}
			
	}
	return mid;      //返回表下标值
};

float get_tem(float res)
{
u16 index=0;
float temp=0;

index=find_PT100(res); //获得下标

	if(0xFFFF==index)     //数据不对
	{
		return 0xFFFF;
		
	}
	if(PT100[index]==res) //数据正好相等
		{
		temp=index;  //取出温度
		}
		else
		{
			if(PT100[index]>res)   //查找到的温度下标对应电阻大于res
			{
			temp=index-1 + (res-PT100[index-1])/(PT100[index]-PT100[index-1]);     //默认这段为线性，比例算出res对应温度
			}
			else             //下标小于res
			{
			temp=index+(res-PT100[index])/(PT100[index+1]-PT100[index]);
			}
		}
		
		
		return temp;
		
		
}

